<!DOCTYPE html>
<html>
<head>
    <title>바나나 히어로 - 미니 게임 엔진</title>
    <style>
        body { 
            margin: 0; 
            background: #2c3e50;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Arial', sans-serif;
        }
        #gameWrapper {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }
        canvas { 
            display: block;
            cursor: pointer;
        }
        #gameInfo {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 18px;
        }
        .debug {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="gameWrapper">
        <div id="gameInfo">
            <div>🎮 바나나 히어로의 모험</div>
            <div id="score">점수: 0</div>
        </div>
        <canvas id="game"></canvas>
    </div>
    
    <div class="debug" id="debug" style="display: none;">
        <div>FPS: <span id="fps">0</span></div>
        <div>Objects: <span id="objects">0</span></div>
        <div>Hero: <span id="heroPos">0, 0</span></div>
    </div>

    <script>
        // 🎮 미니 게임 엔진
        class GameEngine {
            constructor(canvasId, width = 800, height = 400) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.canvas.width = width;
                this.canvas.height = height;
                
                this.gameObjects = [];
                this.keys = {};
                this.lastTime = 0;
                this.deltaTime = 0;
                this.fps = 0;
                this.frameCount = 0;
                this.isRunning = true;
                
                this.setupEvents();
                console.log("🎮 게임 엔진 시작!");
            }
            
            setupEvents() {
                // 키보드 이벤트
                document.addEventListener('keydown', (e) => {
                    this.keys[e.key] = true;
                    this.onKeyDown(e.key);
                });
                
                document.addEventListener('keyup', (e) => {
                    this.keys[e.key] = false;
                });
                
                // 디버그 모드 토글 (D키)
                document.addEventListener('keypress', (e) => {
                    if (e.key === 'd' || e.key === 'D') {
                        const debug = document.getElementById('debug');
                        debug.style.display = debug.style.display === 'none' ? 'block' : 'none';
                    }
                });
            }
            
            // 오버라이드할 메서드들
            onKeyDown(key) {}
            update(deltaTime) {}
            draw() {}
            
            // 게임 오브젝트 관리
            addObject(obj) {
                this.gameObjects.push(obj);
                return obj;
            }
            
            removeObject(obj) {
                const index = this.gameObjects.indexOf(obj);
                if (index > -1) {
                    this.gameObjects.splice(index, 1);
                }
            }
            
            // 충돌 감지
            checkCollision(obj1, obj2) {
                return obj1.x < obj2.x + obj2.width &&
                       obj1.x + obj1.width > obj2.x &&
                       obj1.y < obj2.y + obj2.height &&
                       obj1.y + obj1.height > obj2.y;
            }
            
            // 메인 게임 루프
            gameLoop(currentTime) {
                // Delta time 계산
                this.deltaTime = (currentTime - this.lastTime) / 1000;
                this.lastTime = currentTime;
                
                // FPS 계산
                this.frameCount++;
                if (this.frameCount % 60 === 0) {
                    this.fps = Math.round(1 / this.deltaTime);
                    document.getElementById('fps').textContent = this.fps;
                }
                
                if (this.isRunning) {
                    // 게임 업데이트
                    this.update(this.deltaTime);
                    
                    // 모든 오브젝트 업데이트
                    this.gameObjects.forEach(obj => {
                        if (obj.update) obj.update(this.deltaTime);
                    });
                    
                    // 화면 그리기
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    this.draw();
                    
                    // 모든 오브젝트 그리기
                    this.gameObjects.forEach(obj => {
                        if (obj.draw) obj.draw(this.ctx);
                    });
                }
                
                requestAnimationFrame((time) => this.gameLoop(time));
            }
            
            // 게임 시작
            start() {
                this.gameLoop(0);
            }
        }
        
        // 🎯 게임 오브젝트 기본 클래스
        class GameObject {
            constructor(x, y, width, height, color = 'black') {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.color = color;
                this.velocityX = 0;
                this.velocityY = 0;
            }
            
            update(deltaTime) {
                this.x += this.velocityX * deltaTime * 60;
                this.y += this.velocityY * deltaTime * 60;
            }
            
            draw(ctx) {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }
        }
        
        // 🐵 주인공 클래스
        class Hero extends GameObject {
            constructor(x, y) {
                super(x, y, 50, 50, '#8B4513');
                this.jumpPower = -15;
                this.isJumping = false;
                this.gravity = 0.8;
                this.groundY = y;
            }
            
            update(deltaTime) {
                // 중력 적용
                this.velocityY += this.gravity;
                super.update(deltaTime);
                
                // 바닥 체크
                if (this.y > this.groundY) {
                    this.y = this.groundY;
                    this.velocityY = 0;
                    this.isJumping = false;
                }
            }
            
            draw(ctx) {
                // 몸통
                super.draw(ctx);
                
                // 얼굴
                ctx.fillStyle = '#FFD700';
                ctx.beginPath();
                ctx.arc(this.x + 25, this.y + 20, 15, 0, Math.PI * 2);
                ctx.fill();
                
                // 눈
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.arc(this.x + 20, this.y + 15, 3, 0, Math.PI * 2);
                ctx.arc(this.x + 30, this.y + 15, 3, 0, Math.PI * 2);
                ctx.fill();
            }
            
            jump() {
                if (!this.isJumping) {
                    this.velocityY = this.jumpPower;
                    this.isJumping = true;
                }
            }
            
            moveLeft(speed = 5) {
                if (this.x > 0) {
                    this.x -= speed;
                }
            }
            
            moveRight(speed = 5, maxX) {
                if (this.x < maxX - this.width) {
                    this.x += speed;
                }
            }
        }
        
        // 🍌 바나나 클래스
        class Banana extends GameObject {
            constructor(x, y) {
                super(x, y, 20, 10, '#FFFF00');
                this.velocityX = 10;
            }
        }
        
        // 👹 적 클래스
        class Enemy extends GameObject {
            constructor(x, y) {
                super(x, y, 40, 50, '#FF0000');
                this.velocityX = -3;
                this.isSlipping = false;
            }
            
            slip() {
                this.isSlipping = true;
                this.color = '#FFA500';
                this.velocityX = 5;
            }
        }
        
        // 🎮 실제 게임 구현
        class BananaHeroGame extends GameEngine {
            constructor() {
                super('game');
                
                this.hero = new Hero(100, 300);
                this.bananas = [];
                this.enemies = [];
                this.score = 0;
                this.gameOver = false;
                this.enemySpawnTimer = 0;
                
                this.addObject(this.hero);
                
                // 배경 요소들
                this.setupBackground();
            }
            
            setupBackground() {
                // 구름들
                this.clouds = [
                    { x: 100, y: 50, width: 60, height: 30 },
                    { x: 300, y: 80, width: 80, height: 40 },
                    { x: 600, y: 60, width: 70, height: 35 }
                ];
            }
            
            onKeyDown(key) {
                if (key === 'z' || key === 'Z') {
                    this.shootBanana();
                }
                
                if ((key === 'r' || key === 'R') && this.gameOver) {
                    this.restart();
                }
            }
            
            update(deltaTime) {
                if (this.gameOver) return;
                
                // 주인공 컨트롤
                if (this.keys['ArrowLeft']) {
                    this.hero.moveLeft();
                }
                if (this.keys['ArrowRight']) {
                    this.hero.moveRight(5, this.canvas.width);
                }
                if (this.keys[' ']) {
                    this.hero.jump();
                }
                
                // 적 생성 (3초마다)
                this.enemySpawnTimer += deltaTime;
                if (this.enemySpawnTimer > 3) {
                    this.spawnEnemy();
                    this.enemySpawnTimer = 0;
                }
                
                // 충돌 체크
                this.checkAllCollisions();
                
                // 화면 밖 오브젝트 제거
                this.cleanupObjects();
                
                // 디버그 정보 업데이트
                document.getElementById('objects').textContent = this.gameObjects.length;
                document.getElementById('heroPos').textContent = `${Math.round(this.hero.x)}, ${Math.round(this.hero.y)}`;
            }
            
            draw() {
                // 배경
                this.ctx.fillStyle = '#87CEEB';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // 구름
                this.ctx.fillStyle = 'white';
                this.clouds.forEach(cloud => {
                    this.ctx.fillRect(cloud.x, cloud.y, cloud.width, cloud.height);
                });
                
                // 땅
                this.ctx.fillStyle = '#8FBC8F';
                this.ctx.fillRect(0, 350, this.canvas.width, 50);
                
                // 게임 오버 메시지
                if (this.gameOver) {
                    this.ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                    
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '48px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('GAME OVER', this.canvas.width / 2, this.canvas.height / 2);
                    
                    this.ctx.font = '24px Arial';
                    this.ctx.fillText('R키를 눌러 재시작', this.canvas.width / 2, this.canvas.height / 2 + 50);
                }
            }
            
            shootBanana() {
                const banana = new Banana(this.hero.x + this.hero.width, this.hero.y + 25);
                this.bananas.push(banana);
                this.addObject(banana);
                console.log("🍌 바나나 발사!");
            }
            
            spawnEnemy() {
                const enemy = new Enemy(this.canvas.width, 300);
                this.enemies.push(enemy);
                this.addObject(enemy);
            }
            
            checkAllCollisions() {
                // 바나나와 적 충돌
                this.bananas.forEach((banana, bIndex) => {
                    this.enemies.forEach((enemy, eIndex) => {
                        if (!enemy.isSlipping && this.checkCollision(banana, enemy)) {
                            enemy.slip();
                            this.removeObject(banana);
                            this.bananas.splice(bIndex, 1);
                            this.score += 10;
                            document.getElementById('score').textContent = `점수: ${this.score}`;
                            
                            // 1초 후 적 제거
                            setTimeout(() => {
                                this.removeObject(enemy);
                                const index = this.enemies.indexOf(enemy);
                                if (index > -1) this.enemies.splice(index, 1);
                            }, 1000);
                        }
                    });
                });
                
                // 주인공과 적 충돌
                this.enemies.forEach(enemy => {
                    if (!enemy.isSlipping && this.checkCollision(this.hero, enemy)) {
                        this.gameOver = true;
                        this.isRunning = false;
                    }
                });
            }
            
            cleanupObjects() {
                // 화면 밖 바나나 제거
                this.bananas = this.bananas.filter(banana => {
                    if (banana.x > this.canvas.width) {
                        this.removeObject(banana);
                        return false;
                    }
                    return true;
                });
                
                // 화면 밖 적 제거
                this.enemies = this.enemies.filter(enemy => {
                    if (enemy.x < -enemy.width || enemy.x > this.canvas.width) {
                        this.removeObject(enemy);
                        return false;
                    }
                    return true;
                });
            }
            
            restart() {
                this.gameObjects = [];
                this.hero = new Hero(100, 300);
                this.addObject(this.hero);
                this.bananas = [];
                this.enemies = [];
                this.score = 0;
                this.gameOver = false;
                this.isRunning = true;
                this.enemySpawnTimer = 0;
                document.getElementById('score').textContent = '점수: 0';
            }
        }
        
        // 🚀 게임 시작!
        const game = new BananaHeroGame();
        game.start();
    </script>
</body>
</html>